{% extends "base.html" %}
{% block title %}Pipeline Cost Estimator - VibeOps{% endblock %}

{% block content %}
    <section class="pipeline-estimator-page">
        <h2 data-aos="fade-up" data-aos-delay="100" class="glitch" data-text="Pipeline Estimator">Pipeline Cost Estimator Tool</h2>
        <p data-aos="fade-up" data-aos-delay="200" class="text-center">Enter pipeline details to get an estimated Bill of Materials and cost.</p>

        <div class="input-section" data-aos="fade-up" data-aos-delay="300">
            <form id="estimationForm" class="space-y-6">
                <div>
                    <label for="length">Pipeline Length (km)</label>
                    <input type="number" name="length" id="length" step="any" class="pipe-length" required placeholder="e.g., 10.5">
                </div>

                <div>
                    <label for="diameter">Pipeline Diameter (inches)</label>
                    <input type="number" name="diameter" id="diameter" class="pipe-diameter" step="any" required placeholder="e.g., 24">
                </div>

                <div>
                    <label for="terrain">Terrain Type</label>
                    <select id="terrain" class="pipe-terrain" name="terrain" required>
                        <option value="">Select Terrain</option>
                        <option value="flat">Flat</option>
                        <option value="hilly">Hilly</option>
                        <option value="mountainous">Mountainous</option>
                        <option value="swampy">Swampy</option>
                    </select>
                </div>

                <div>
                    <button type="submit" class="btn primary w-full flex justify-center">
                        Get Estimate
                    </button>
                </div>
            </form>
             <div id="form-error-message" class="text-center" style="color: red; margin-top: 1rem;"></div>
        </div>

        <div id="results" class="output-section hidden" data-aos="fade-up" data-aos-delay="400">
            <h2>Estimation Results</h2>
            <div id="bom" class="box mb-4"></div>
            <div id="cost" class="box"></div>
        </div>
    </section>

    {% block extra_scripts %}
    <script>
        document.getElementById('estimationForm').addEventListener('submit', function(event) {
            event.preventDefault();

            const form = event.target;
            const formData = new FormData(form);
            const data = Object.fromEntries(formData.entries());

            console.log('Form submitted with data:', data);

            // Clear previous results and errors
            const resultsDiv = document.getElementById('results');
            const bomDiv = document.getElementById('bom');
            const costDiv = document.getElementById('cost');
            const errorMessageDiv = document.getElementById('form-error-message');

            resultsDiv.classList.add('hidden');
            bomDiv.innerHTML = '';
            costDiv.innerHTML = '';
            errorMessageDiv.textContent = '';

            // Show loading messages in the results area
            resultsDiv.classList.remove('hidden');
            bomDiv.innerHTML = 'Calculating BOM...';
            costDiv.innerHTML = 'Estimating cost...';

            // Send data to backend Flask route
            fetch('/pipeline-estimator', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify(data)
            })
            .then(response => {
                if (!response.ok) {
                    // If response is not OK, try to read the error message from backend
                    return response.json().then(data => {
                        throw new Error(data.error || `HTTP error! status: ${response.status}`);
                    }).catch(() => {
                         // If json parsing fails, throw generic error
                         throw new Error(`HTTP error! status: ${response.status}`);
                    });
                }
                return response.json();
            })
            .then(result => {
                console.log('Backend response:', result);

                // Clear loading messages
                bomDiv.innerHTML = '';
                costDiv.innerHTML = '';

                if (result.bom) {
                    // Format BOM as a list for better readability
                    let bomHtml = '<h4 class="font-semibold" style="color: #00ffcc;">Bill of Materials:</h4><ul>';
                    Object.entries(result.bom).forEach(([item, quantity]) => {
                        bomHtml += `<li><strong>${item}:</strong> ${quantity}</li>`;
                    });
                    bomHtml += '</ul>';
                    bomDiv.innerHTML = bomHtml;
                } else {
                     bomDiv.innerHTML = '<h4 class="font-semibold" style="color: #00ffcc;">Bill of Materials:</h4> Calculation failed or no BOM provided.';
                }

                if (result.cost) {
                    // Format cost breakdown
                    let costHtml = '<h4 class="font-semibold" style="color: #00ffcc;">Estimated Cost Breakdown:</h4><ul>';
                    costHtml += `<li><strong>Total Cost:</strong> $${result.cost.total_cost.toLocaleString()}</li>`;
                    costHtml += `<li><strong>Material Cost:</strong> $${result.cost.material_cost.toLocaleString()}</li>`;
                    costHtml += `<li><strong>Labor Cost:</strong> $${result.cost.labor_cost.toLocaleString()}</li>`;
                    costHtml += `<li><strong>Right-of-Way Cost:</strong> $${result.cost.row_cost.toLocaleString()}</li>`;
                    costHtml += `<li><strong>Miscellaneous Cost:</strong> $${result.cost.misc_cost.toLocaleString()}</li>`;
                    costHtml += '</ul>';

                    costDiv.innerHTML = costHtml;
                } else {
                    costDiv.innerHTML = '<h4 class="font-semibold" style="color: #00ffcc;">Estimated Cost:</h4> Estimation failed or no cost provided.';
                }
            })
            .catch(error => {
                console.error('Error during fetch:', error);
                 // Display error message prominently
                errorMessageDiv.textContent = `Error: ${error.message || 'Failed to get estimation.'}`;
                // Clear results content if there was an error after loading
                bomDiv.innerHTML = '';
                costDiv.innerHTML = '';
                // Optionally hide the results section again if no valid data was ever received
                // resultsDiv.classList.add('hidden');
            });
        });
    </script>
    {% endblock %}
{% endblock %}