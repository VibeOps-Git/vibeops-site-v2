{% extends "base.html" %}
{% block title %}Construction Tracker â€“ VibeOps{% endblock %}

{% block extra_head %}
  <!-- Plotly (for Gantt, histograms, S-curves, etc.) -->
  <script src="https://cdn.plot.ly/plotly-2.18.1.min.js"></script>
{% endblock %}

{% block content %}
  <section class="construction-tracker-page" data-aos="fade-in" data-aos-duration="1000">
    <h2
      data-aos="fade-up"
      data-aos-delay="100"
      class="construction-tracker-glitch"
      data-text="Construction Tracker"
    >
      Construction Tracker
    </h2>
    <p data-aos="fade-up" data-aos-delay="200" class="construction-tracker-text-center">
      Define your project tasks below. You can also click â€œInsert example scheduleâ€ to load a sample.
      Once your tasks are in place, hit â€œGenerate Plan (Gantt Chart)â€.
    </p>

    <!-- â”€â”€â”€ INPUT SECTION â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ -->
    <div class="construction-tracker-input-section" data-aos="fade-up" data-aos-delay="300">
      <!-- Project Name -->
      <div style="margin-bottom: 1rem;">
        <label for="project_name">Project Name</label><br>
        <input
          type="text"
          id="project_name"
          class="construction-tracker-project-name"
          placeholder="e.g., Office Building Renovation"
          required
          style="width: 100%; padding: .75rem; border: 1px solid #444; border-radius: 6px; background:#3e3e3e; color:#f2f2f2;"
        >
      </div>

      <!-- â”€â”€â”€ â€œDefine Project Tasksâ€ TABLE â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ -->
      <div id="task-list" class="construction-tracker-task-list" style="margin-bottom: 1.5rem;">
        <h3 class="construction-tracker-task-heading" style="color: #00a886; margin-bottom: .5rem;">
          Define Project Tasks
        </h3>

        <table
          id="tasks-table"
          class="task-table"
          style="width: 100%; border-collapse: collapse; margin-bottom: .5rem;"
        >
          <thead>
            <tr style="background: #3e3e3e; color: #f2f2f2;">
              <th style="padding: .5rem; border: 1px solid #444;">Task Name</th>
              <th style="padding: .5rem; border: 1px solid #444;">Phase</th>
              <th style="padding: .5rem; border: 1px solid #444;">Start Date</th>
              <th style="padding: .5rem; border: 1px solid #444;">Duration (days)</th>
              <th style="padding: .5rem; border: 1px solid #444;">Predecessors</th>
              <th style="padding: .5rem; border: 1px solid #444;">Crew ID</th>
              <th style="padding: .5rem; border: 1px solid #444;">Personnel</th>
              <th style="padding: .5rem; border: 1px solid #444;">Equipment</th>
              <th style="padding: .5rem; border: 1px solid #444;">Actions</th>
            </tr>
          </thead>
          <tbody id="tasks-container">
            <!-- JavaScript will append <tr> rows here -->
          </tbody>
        </table>

        <button
          type="button"
          id="add-task"
          class="construction-tracker-btn secondary w-full"
          style="margin-top: .5rem;"
        >
          + Add Task
        </button>
      </div>
      <!-- â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ -->

      <!-- â€œInsert Example Scheduleâ€ and â€œGenerate Planâ€ buttons -->
      <div class="mt-4" style="display: flex; gap: 1rem; flex-wrap: wrap;">
        <button
          type="button"
          id="load-example-schedule"
          class="construction-tracker-btn secondary"
          style="flex: 1;"
        >
          Insert Example Schedule
        </button>
        <button
          type="button"
          id="generate-gantt"
          class="construction-tracker-btn primary"
          style="flex: 1;"
        >
          Generate Plan (Gantt Chart)
        </button>
      </div>

      <!-- Error message placeholder for task validation -->
      <div
        id="task-form-error-message"
        class="construction-tracker-error-message"
        style="color: red; margin-top: 1rem; text-align: center;"
      ></div>
    </div>
    <!-- â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ -->


    <!-- â”€â”€â”€ GANTT CHART DISPLAY â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ -->
    <div id="gantt-results" class="construction-tracker-output-section mt-8 hidden">
      <h2 style="margin-bottom: .75rem; color: #00a886;">Project Gantt Chart</h2>
      <div
        id="gantt-chart"
        class="construction-tracker-box"
        style="position: relative; min-height: 300px; background: #282828; border:1px solid #333; border-radius:8px; padding:1rem;"
      >
        <!-- Loading spinner (hidden by default) -->
        <div
          id="gantt-loading-spinner"
          class="construction-tracker-loading-spinner hidden"
          style="
            border: 8px solid #1e1e1e;
            border-top: 8px solid #00ffcc;
            border-radius: 50%;
            width: 60px;
            height: 60px;
            animation: spin 1s linear infinite;
            position: absolute;
            top: calc(50% - 30px);
            left: calc(50% - 30px);
          "
        ></div>
      </div>
    </div>
    <!-- â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ -->


    <!-- â”€â”€â”€ PROGRESS SECTION (hidden until Gantt is generated) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ -->
    <div id="progress-section" class="construction-tracker-input-section mt-8 hidden">
      <h3 style="color: #00a886; margin-bottom: .75rem;">Report Progress & Costs</h3>
      <div
        id="progress-form-error-message"
        class="construction-tracker-error-message"
        style="color: red; margin-bottom: 1rem;"
      ></div>

      <!-- â”€â”€â”€ â€œInsert Example Progress Dataâ€ button â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ -->
      <button
        type="button"
        id="load-example-progress"
        class="construction-tracker-btn secondary w-full"
        style="margin-bottom: 1rem;"
      >
        Insert Example Progress Data
      </button>
      <!-- â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ -->

      <!-- â€œReport Progress & Costsâ€ TABLE -->
      <table
        id="progress-table"
        style="width: 100%; border-collapse: collapse; margin-bottom: .5rem;"
      >
        <thead>
          <tr style="background: #3e3e3e; color: #f2f2f2;">
            <th style="padding: .5rem; border: 1px solid #444;">Task Name</th>
            <th style="padding: .5rem; border: 1px solid #444;">Budgeted Cost ($)</th>
            <th style="padding: .5rem; border: 1px solid #444;">Actual Cost ($)</th>
            <th style="padding: .5rem; border: 1px solid #444;">% Complete</th>
            <th style="padding: .5rem; border: 1px solid #444;">Actual Start</th>
            <th style="padding: .5rem; border: 1px solid #444;">Actual Finish</th>
          </tr>
        </thead>
        <tbody id="progress-list">
          <!-- JavaScript will append <tr> rows here -->
        </tbody>
      </table>

      <button
        type="button"
        id="submit-progress"
        class="construction-tracker-btn primary w-full"
        style="margin-top: 1rem;"
      >
        Analyze Progress (S-Curves)
      </button>
    </div>
    <!-- â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ -->


    <!-- â”€â”€â”€ S-CURVE & METRICS (hidden until progress is submitted) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ -->
    <div id="analysis-results" class="output-section mt-8 hidden">
      <h2 style="color: #00a886; margin-bottom: .75rem;">Performance Analysis</h2>
      <div
        id="s-curve-chart"
        class="construction-tracker-box mb-4"
        style="min-height: 300px; background: #282828; border:1px solid #333; border-radius:8px; padding:1rem;"
      ></div>
      <div
        id="metrics"
        class="construction-tracker-box"
        style="min-height: 120px; padding: 1rem; background: #282828; border:1px solid #333; border-radius:8px;"
      ></div>
    </div>
    <!-- â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ -->


    <!-- â”€â”€â”€ RESOURCE HISTOGRAMS (hidden until Gantt is generated) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ -->
    <div id="resource-histograms" class="construction-tracker-output-section mt-8 hidden">
      <h2 style="color: #00a886; margin-bottom: .75rem;">Resource Usage</h2>
      <!-- Personnel (Employees) Histogram -->
      <div
        id="personnel-histogram"
        class="construction-tracker-box mb-4"
        style="min-height: 200px; background: #282828; border:1px solid #333; border-radius:8px; padding:1rem;"
      ></div>
      <!-- Equipment Histogram -->
      <div
        id="equipment-histogram"
        class="construction-tracker-box"
        style="min-height: 200px; background: #282828; border:1px solid #333; border-radius:8px; padding:1rem;"
      ></div>
    </div>
    <!-- â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ -->


    <!-- â”€â”€â”€ INSIGHT DASHBOARD (NEW) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ -->
    <div id="insights" class="construction-tracker-output-section mt-8 hidden">
      <h2 style="color: #00a886; margin-bottom: .75rem;">Project Insights</h2>
      <div
        id="insights-content"
        class="construction-tracker-box"
        style="padding: 1rem; background: #282828; border:1px solid #333; border-radius:8px; color: #f2f2f2;"
      >
        <!-- JS will inject â€œOver/Under budgetâ€ & â€œAhead/Behind scheduleâ€ text here -->
      </div>
    </div>
    <!-- â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ -->


    <!-- Full-screen Gantt Modal (unchanged) -->
    <div id="gantt-modal" class="modal">
      <div class="modal-content">
        <span class="close-modal">&times;</span>
        <div id="fullscreen-gantt-chart" style="width:100%; height: calc(90vh - 60px);"></div>
      </div>
    </div>
  </section>
{% endblock %}


{% block extra_scripts %}
  <script>
    // â”€â”€â”€ UTILITY FUNCTIONS â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    function formatDate(dt) {
      return dt.toISOString().split('T')[0];
    }
    function showElement(el) { el.classList.remove('hidden'); }
    function hideElement(el) { el.classList.add('hidden'); }

    // Spinner animation keyframes
    const styleSheet = document.createElement("style");
    styleSheet.innerText = `
      @keyframes spin {
        0% { transform: rotate(0deg); }
        100% { transform: rotate(360deg); }
      }
    `;
    document.head.appendChild(styleSheet);
    // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€


    // â”€â”€â”€ TASK INPUT MANAGEMENT (TABLE-BASED) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    let taskCount = 0;
    const tasksContainer = document.getElementById('tasks-container');
    const addTaskBtn     = document.getElementById('add-task');
    const exampleBtn     = document.getElementById('load-example-schedule');

    // Eight example tasks (to populate on button click)
    const exampleTasks = [
      {
        "Task": "A",
        "Start": formatDate(new Date()),
        "End":   formatDate(new Date(Date.now() + 2*24*3600*1000)),
        "Duration": 3,
        "immediatePredecessor": [],
        "crew": "C-1",
        "personnel": 5,
        "equipment": 1
      },
      {
        "Task": "B",
        "Start": formatDate(new Date()),
        "End":   formatDate(new Date(Date.now() + 3*24*3600*1000)),
        "Duration": 4,
        "immediatePredecessor": [],
        "crew": "C-2",
        "personnel": 6,
        "equipment": "0"
      },
      {
        "Task": "C",
        "Start": formatDate(new Date(Date.now() + 2*24*3600*1000)),
        "End":   formatDate(new Date(Date.now() + 5*24*3600*1000)),
        "Duration": 4,
        "immediatePredecessor": ["A"],
        "crew": "C-1",
        "personnel": 5,
        "equipment": 1
      },
      {
        "Task": "D",
        "Start": formatDate(new Date(Date.now() + 2*24*3600*1000)),
        "End":   formatDate(new Date(Date.now() + 8*24*3600*1000)),
        "Duration": 7,
        "immediatePredecessor": ["A"],
        "crew": "C-3",
        "personnel": 4,
        "equipment": 1
      },
      {
        "Task": "E",
        "Start": formatDate(new Date(Date.now() + 5*24*3600*1000)),
        "End":   formatDate(new Date(Date.now() + 8*24*3600*1000)),
        "Duration": 4,
        "immediatePredecessor": ["C"],
        "crew": "C-1",
        "personnel": 5,
        "equipment": 1
      },
      {
        "Task": "F",
        "Start": formatDate(new Date(Date.now() + 5*24*3600*1000)),
        "End":   formatDate(new Date(Date.now() + 11*24*3600*1000)),
        "Duration": 7,
        "immediatePredecessor": ["C"],
        "crew": "C-4",
        "personnel": 7,
        "equipment": "0"
      },
      {
        "Task": "G",
        "Start": formatDate(new Date(Date.now() + 8*24*3600*1000)),
        "End":   formatDate(new Date(Date.now() + 10*24*3600*1000)),
        "Duration": 3,
        "immediatePredecessor": ["D", "E"],
        "crew": "C-5",
        "personnel": 3,
        "equipment": "0"
      },
      {
        "Task": "H",
        "Start": formatDate(new Date(Date.now() + 11*24*3600*1000)),
        "End":   formatDate(new Date(Date.now() + 17*24*3600*1000)),
        "Duration": 7,
        "immediatePredecessor": ["F", "G"],
        "crew": "C-4",
        "personnel": 7,
        "equipment": 1
      }
    ];

    function addTaskRow(task = {}) {
      taskCount++;
      const tbody = document.getElementById('tasks-container');

      // Compute durationVal if Start & End exist
      let durationVal = task.Duration || '';
      if (task.Start && task.End) {
        const s = new Date(task.Start), e = new Date(task.End);
        const diffDays = Math.ceil((e - s) / (1000 * 3600 * 24)) + 1;
        durationVal = diffDays;
      }

      const tr = document.createElement('tr');
      tr.id = `task-row-${taskCount}`;
      tr.innerHTML = `
        <td style="border:1px solid #444; padding:.5rem;">
          <input
            type="text"
            class="task-name"
            placeholder="Task Name"
            value="${task.Task || ''}"
            required
            style="width:100%; padding:.5rem; border:1px solid #444; border-radius:6px; background:#3e3e3e; color:#f2f2f2;"
          />
        </td>
        <td style="border:1px solid #444; padding:.5rem;">
          <input
            type="text"
            class="task-phase"
            placeholder="Phase"
            value="${task.phase || ''}"
            style="width:100%; padding:.5rem; border:1px solid #444; border-radius:6px; background:#3e3e3e; color:#f2f2f2;"
          />
        </td>
        <td style="border:1px solid #444; padding:.5rem;">
          <input
            type="date"
            class="task-start"
            value="${task.Start || ''}"
            required
            style="width:100%; padding:.5rem; border:1px solid #444; border-radius:6px; background:#3e3e3e; color:#f2f2f2;"
          />
        </td>
        <td style="border:1px solid #444; padding:.5rem;">
          <input
            type="number"
            class="task-duration"
            placeholder="Duration"
            value="${durationVal}"
            min="1"
            required
            style="width:100%; padding:.5rem; border:1px solid #444; border-radius:6px; background:#3e3e3e; color:#f2f2f2;"
          />
        </td>
        <td style="border:1px solid #444; padding:.5rem;">
          <input
            type="text"
            class="task-predecessors"
            placeholder="Predecessors"
            value="${(task.immediatePredecessor || []).join(', ')}"
            style="width:100%; padding:.5rem; border:1px solid #444; border-radius:6px; background:#3e3e3e; color:#f2f2f2;"
          />
        </td>
        <td style="border:1px solid #444; padding:.5rem;">
          <input
            type="text"
            class="task-crew"
            placeholder="Crew ID"
            value="${task.crew || ''}"
            required
            style="width:100%; padding:.5rem; border:1px solid #444; border-radius:6px; background:#3e3e3e; color:#f2f2f2;"
          />
        </td>
        <td style="border:1px solid #444; padding:.5rem;">
          <input
            type="number"
            class="task-personnel"
            placeholder="Personnel"
            value="${task.personnel || ''}"
            min="0"
            required
            style="width:100%; padding:.5rem; border:1px solid #444; border-radius:6px; background:#3e3e3e; color:#f2f2f2;"
          />
        </td>
        <td style="border:1px solid #444; padding:.5rem;">
          <input
            type="number"
            class="task-equipment"
            placeholder="Equipment"
            value="${task.equipment || ''}"
            min="0"
            required
            style="width:100%; padding:.5rem; border:1px solid #444; border-radius:6px; background:#3e3e3e; color:#f2f2f2;"
          />
        </td>
        <td style="border:1px solid #444; padding:.5rem; text-align:center;">
          <button type="button" class="remove-task construction-tracker-btn secondary">Remove</button>
        </td>
      `;

      // â€œRemoveâ€ logic
      tr.querySelector('.remove-task').addEventListener('click', () => {
        tbody.removeChild(tr);
      });

      tbody.appendChild(tr);
    }

    // Add a brand-new (empty) task row
    addTaskBtn.addEventListener('click', e => {
      e.preventDefault();
      addTaskRow();
    });

    // â€œInsert Example Scheduleâ€ clears existing rows and populates the eight sample tasks
    exampleBtn.addEventListener('click', e => {
      e.preventDefault();
      tasksContainer.innerHTML = '';
      exampleTasks.forEach(t => addTaskRow(t));
    });

    // On page load: add one blank row so user can start typing immediately
    document.addEventListener('DOMContentLoaded', () => {
      addTaskRow();
    });
    // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€


    // â”€â”€â”€ GENERATE GANTT BUTTON â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    document.getElementById('generate-gantt').addEventListener('click', () => {
      const projectNameInput = document.getElementById('project_name');
      const errorDiv         = document.getElementById('task-form-error-message');
      errorDiv.textContent = '';

      const projectName = projectNameInput.value.trim();
      if (!projectName) {
        errorDiv.textContent = 'Please enter a project name.';
        projectNameInput.style.borderColor = 'red';
        return;
      }
      projectNameInput.style.borderColor = '';

      // Collect all <tr> rows from the tasks table
      const rowElements    = Array.from(document.querySelectorAll('#tasks-container tr'));
      const collectedTasks = [];
      let formIsValid = true;

      rowElements.forEach(tr => {
        const nameEl      = tr.querySelector('.task-name');
        const phaseEl     = tr.querySelector('.task-phase');
        const startEl     = tr.querySelector('.task-start');
        const durationEl  = tr.querySelector('.task-duration');
        const predEl      = tr.querySelector('.task-predecessors');
        const crewEl      = tr.querySelector('.task-crew');
        const personnelEl = tr.querySelector('.task-personnel');
        const equipmentEl = tr.querySelector('.task-equipment');

        const name       = nameEl.value.trim();
        const phase      = phaseEl.value.trim();
        const start      = startEl.value;
        const duration   = parseInt(durationEl.value, 10);
        const preds      = predEl.value.trim().split(',').map(p => p.trim()).filter(p => p !== '');
        const crew       = crewEl.value.trim();
        const personnel  = parseInt(personnelEl.value, 10);
        const equipment  = parseInt(equipmentEl.value, 10);

        // Basic validation:
        if (
          !name ||
          !start ||
          isNaN(duration) || duration < 1 ||
          !crew ||
          isNaN(personnel) || personnel < 0 ||
          isNaN(equipment) || equipment < 0
        ) {
          formIsValid = false;
          nameEl.style.borderColor       = name       ? '' : 'red';
          startEl.style.borderColor      = start      ? '' : 'red';
          durationEl.style.borderColor   = (!isNaN(duration) && duration > 0) ? '' : 'red';
          crewEl.style.borderColor       = crew       ? '' : 'red';
          personnelEl.style.borderColor  = (!isNaN(personnel) && personnel >= 0) ? '' : 'red';
          equipmentEl.style.borderColor  = (!isNaN(equipment) && equipment >= 0) ? '' : 'red';
        } else {
          // Clear any red border if it was previously highlighted
          nameEl.style.borderColor       = '';
          startEl.style.borderColor      = '';
          durationEl.style.borderColor   = '';
          crewEl.style.borderColor       = '';
          personnelEl.style.borderColor  = '';
          equipmentEl.style.borderColor  = '';

          collectedTasks.push({
            activityName: name,
            phase:        phase,
            start:        start,
            duration:     duration,
            immediatePredecessor: preds,
            crew:         crew,
            personnel:    personnel,
            equipment:    equipment
          });
        }
      });

      if (!formIsValid) {
        errorDiv.textContent = 'Please fill in all required task details correctly.';
        return;
      }
      if (collectedTasks.length === 0) {
        errorDiv.textContent = 'Please add at least one task before generating.';
        return;
      }

      // Validate that all predecessors exist in the set of task names
      const nameSet = new Set(collectedTasks.map(t => t.activityName));
      for (let t of collectedTasks) {
        for (let p of t.immediatePredecessor) {
          if (!nameSet.has(p)) {
            formIsValid = false;
            errorDiv.textContent = `Predecessor "${p}" not found for task "${t.activityName}".`;
            // Highlight that particular predecessor field:
            rowElements.forEach(tr => {
              if (tr.querySelector('.task-name').value.trim() === t.activityName) {
                tr.querySelector('.task-predecessors').style.borderColor = 'red';
              }
            });
            break;
          }
        }
        if (!formIsValid) break;
      }
      if (!formIsValid) return;

      // All validation passed â†’ show spinner & send to backend
      const ganttDiv      = document.getElementById('gantt-chart');
      const ganttResults  = document.getElementById('gantt-results');
      const spinner       = document.getElementById('gantt-loading-spinner');

      showElement(ganttResults);
      ganttDiv.innerHTML = '';
      ganttDiv.appendChild(spinner);
      showElement(spinner);

      // Hide progress/analysis until new Gantt arrives
      document.getElementById('progress-section').classList.add('hidden');
      document.getElementById('analysis-results').classList.add('hidden');
      document.getElementById('resource-histograms').classList.add('hidden');
      document.getElementById('insights').classList.add('hidden');

      fetch('/construction-tracker', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ project_name: projectName, tasks: collectedTasks })
      })
      .then(resp => resp.ok
        ? resp.json()
        : resp.json().then(d => { throw new Error(d.error || `HTTP ${resp.status}`); })
      )
      .then(result => {
        hideElement(spinner);
        ganttDiv.innerHTML = '';

        if (result.gantt_data) {
          const data   = result.gantt_data.data;
          const layout = result.gantt_data.layout;

          // Attach to dataset so modal can re-plot later
          ganttDiv.dataset.plotData    = JSON.stringify(data);
          ganttDiv.dataset.plotLayout  = JSON.stringify(layout);
          ganttDiv.dataset.projectName = projectName;

          // Adjust inline layout height based on number of tasks
          const inlineLayout = JSON.parse(JSON.stringify(layout));
          inlineLayout.height = Math.max(300, collectedTasks.length * 30);

          // Plot inline Gantt
          Plotly.newPlot('gantt-chart', data, inlineLayout, {
            responsive: true,
            displayModeBar: true,
            modeBarButtonsToRemove: ['toImage','lasso2d','select2d'],
            displaylogo: false
          });

          // â”€â”€â”€ ALWAYS PLOT RESOURCE HISTOGRAMS â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
          const personnelDiv = document.getElementById('personnel-histogram');
          if (result.personnel_data) {
            Plotly.newPlot(
              'personnel-histogram',
              result.personnel_data.data,
              result.personnel_data.layout,
              {responsive: true, displayModeBar: false}
            );
          } else {
            personnelDiv.innerHTML = '<div style="color:red;text-align:center;">No personnel data received.</div>';
          }

          const equipmentDiv = document.getElementById('equipment-histogram');
          if (result.equipment_data) {
            Plotly.newPlot(
              'equipment-histogram',
              result.equipment_data.data,
              result.equipment_data.layout,
              {responsive: true, displayModeBar: false}
            );
          } else {
            equipmentDiv.innerHTML = '<div style="color:red;text-align:center;">No equipment data received.</div>';
          }

          // Show the resource histograms section unconditionally
          showElement(document.getElementById('resource-histograms'));

          // Prepare progress section
          window.taskList = collectedTasks; // store globally
          populateProgressSection();
        } else {
          ganttDiv.innerHTML = '<div style="color:red;text-align:center;">No Gantt data received.</div>';
        }
      })
      .catch(err => {
        hideElement(spinner);
        ganttDiv.innerHTML = `<div style="color:red;text-align:center;">Error: ${err.message}</div>`;
      });
    });
    // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€


    // â”€â”€â”€ POPULATE â€œReport Progress & Costsâ€ TABLE â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    function populateProgressSection() {
      const progressSection = document.getElementById('progress-section');
      const tbody           = document.getElementById('progress-list');
      tbody.innerHTML       = '';

      if (window.taskList && window.taskList.length > 0) {
        window.taskList.forEach((task, idx) => {
          const tr = document.createElement('tr');
          tr.innerHTML = `
            <td style="border:1px solid #444; padding:.5rem;">${task.activityName}</td>
            <td style="border:1px solid #444; padding:.5rem;">
              <input
                type="number"
                class="budgeted-cost"
                data-idx="${idx}"
                min="0"
                value="0"
                style="width:100%; padding:.5rem; border:1px solid #444; border-radius:6px; background:#3e3e3e; color:#f2f2f2;"
              />
            </td>
            <td style="border:1px solid #444; padding:.5rem;">
              <input
                type="number"
                class="actual-cost"
                data-idx="${idx}"
                min="0"
                value="0"
                style="width:100%; padding:.5rem; border:1px solid #444; border-radius:6px; background:#3e3e3e; color:#f2f2f2;"
              />
            </td>
            <td style="border:1px solid #444; padding:.5rem;">
              <input
                type="number"
                class="progress-percent"
                data-idx="${idx}"
                min="0"
                max="100"
                value="0"
                style="width:100%; padding:.5rem; border:1px solid #444; border-radius:6px; background:#3e3e3e; color:#f2f2f2;"
              />
            </td>
            <td style="border:1px solid #444; padding:.5rem;">
              <input
                type="date"
                class="actual-start"
                data-idx="${idx}"
                style="width:100%; padding:.5rem; border:1px solid #444; border-radius:6px; background:#3e3e3e; color:#f2f2f2;"
              />
            </td>
            <td style="border:1px solid #444; padding:.5rem;">
              <input
                type="date"
                class="actual-finish"
                data-idx="${idx}"
                style="width:100%; padding:.5rem; border:1px solid #444; border-radius:6px; background:#3e3e3e; color:#f2f2f2;"
              />
            </td>
          `;
          tbody.appendChild(tr);
        });
        showElement(progressSection);
      } else {
        hideElement(progressSection);
      }
    }
    // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€


    // â”€â”€â”€ â€œINSERT EXAMPLE PROGRESS DATAâ€ BUTTON HANDLER â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    document.getElementById('load-example-progress').addEventListener('click', () => {
      if (!window.taskList || window.taskList.length === 0) {
        alert('No tasks available yet. Generate a Gantt chart first.');
        return;
      }

      // Find each <tr> in the progress table and fill with example data
      const rows = Array.from(document.querySelectorAll('#progress-list tr'));
      rows.forEach((tr, idx) => {
        const task = window.taskList[idx];
        if (!task) return;

        // Build example â€œactualâ€ dates from planned start/duration
        const plannedStartDate = new Date(task.start);
        const durationDays     = parseInt(task.duration, 10) || 1;
        const actualStartDate  = plannedStartDate;
        const halfwayDays      = Math.floor(durationDays / 2);
        const exampleFinishDate = new Date(plannedStartDate.getTime() + halfwayDays * 24*3600*1000);

        // Example numbers
        const budgetedExample    = 1000 + idx * 100;
        const actualCostExample  = Math.round(budgetedExample * 0.8);
        const percentExample     = (durationDays > 1 ? 50 : 100);

        // Set values in each input
        const budgetEl    = tr.querySelector('.budgeted-cost');
        const actualCostEl= tr.querySelector('.actual-cost');
        const percentEl   = tr.querySelector('.progress-percent');
        const startEl     = tr.querySelector('.actual-start');
        const finishEl    = tr.querySelector('.actual-finish');

        budgetEl.value       = budgetedExample;
        actualCostEl.value   = actualCostExample;
        percentEl.value      = percentExample;
        startEl.value        = actualStartDate.toISOString().slice(0,10);
        finishEl.value       = exampleFinishDate.toISOString().slice(0,10);

        // Clear any previous error highlight
        [budgetEl, actualCostEl, percentEl, startEl, finishEl].forEach(el => {
          el.style.borderColor = '';
        });
      });
    });
    // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€


    // â”€â”€â”€ SUBMIT PROGRESS & PLOT S-CURVES â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    document.getElementById('submit-progress').addEventListener('click', () => {
      const errorDiv   = document.getElementById('progress-form-error-message');
      const sCurveDiv  = document.getElementById('s-curve-chart');
      const metricsDiv = document.getElementById('metrics');
      errorDiv.textContent = '';
      sCurveDiv.innerHTML  = 'Analyzingâ€¦';
      metricsDiv.innerHTML = 'Calculatingâ€¦';

      // Collect data from each <tr> in the progress table
      const rows         = Array.from(document.querySelectorAll('#progress-list tr'));
      const progressData = [];
      let valid         = true;

      rows.forEach((tr, idx) => {
        const budgetEl     = tr.querySelector('.budgeted-cost');
        const actualCostEl = tr.querySelector('.actual-cost');
        const percentEl    = tr.querySelector('.progress-percent');
        const startEl      = tr.querySelector('.actual-start');
        const finishEl     = tr.querySelector('.actual-finish');

        const budgeted    = parseFloat(budgetEl.value);
        const actualCost  = parseFloat(actualCostEl.value);
        const percent     = parseFloat(percentEl.value);
        const actualStart = startEl.value;
        const actualFinish= finishEl.value;

        if (isNaN(budgeted) || budgeted < 0) {
          valid = false;
          budgetEl.style.borderColor = 'red';
        } else {
          budgetEl.style.borderColor = '';
        }

        if (isNaN(actualCost) || actualCost < 0) {
          valid = false;
          actualCostEl.style.borderColor = 'red';
        } else {
          actualCostEl.style.borderColor = '';
        }

        if (isNaN(percent) || percent < 0 || percent > 100) {
          valid = false;
          percentEl.style.borderColor = 'red';
        } else {
          percentEl.style.borderColor = '';
        }

        if (!valid) return;

        progressData.push({
          taskIndex:       idx,
          percentComplete: percent,
          actualCost:      actualCost,
          budgetedCost:    budgeted,
          actualStart:     actualStart,
          actualFinish:    actualFinish
        });
      });

      if (!valid) {
        errorDiv.textContent = 'Please correct the highlighted fields.';
        return;
      }

      fetch('/construction-tracker-progress', {
        method:  'POST',
        headers: {'Content-Type':'application/json'},
        body:    JSON.stringify({
          tasks:       window.taskList,
          progress:    progressData,
          report_date: formatDate(new Date())
        })
      })
      .then(resp => resp.ok 
        ? resp.json() 
        : resp.json().then(d => { throw new Error(d.error || `HTTP ${resp.status}`); })
      )
      .then(res => {
        sCurveDiv.innerHTML  = '';
        metricsDiv.innerHTML = '';

        if (res.s_curve_data) {
          Plotly.newPlot('s-curve-chart', res.s_curve_data.data, res.s_curve_data.layout, {responsive:true});
        } else {
          sCurveDiv.innerHTML = '<div style="color:red;text-align:center;">Failed to generate S-curve.</div>';
        }

        if (res.metrics) {
          metricsDiv.innerHTML = `
            <h4 style="color:#00ffcc; margin-bottom:.5rem;">Performance Metrics:</h4>
            <p><strong>Schedule Variance (SV):</strong> ${res.metrics.schedule_variance != null ? '$'+res.metrics.schedule_variance.toLocaleString() : 'N/A'}</p>
            <p><strong>Cost Variance (CV):</strong> ${res.metrics.cost_variance != null ? '$'+res.metrics.cost_variance.toLocaleString() : 'N/A'}</p>
            <p><strong>Critical Path:</strong> ${res.metrics.critical_path || 'N/A'}</p>
            ${res.metrics.planned_finish ? `<p><strong>Planned Finish:</strong> ${res.metrics.planned_finish}</p>` : ''}
            <p><strong>SPI:</strong> ${res.metrics.schedule_performance_index}</p>
            <p><strong>CPI:</strong> ${res.metrics.cost_performance_index}</p>
          `;
        } else {
          metricsDiv.innerHTML = '<div style="color:red;">Failed to calculate metrics.</div>';
        }

        showElement(document.getElementById('analysis-results'));

        // â”€â”€â”€ NEW: POPULATE â€œPROJECT INSIGHTSâ€ PANEL â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
        const insightsDiv = document.getElementById('insights-content');
        let insightsHtml = "";
        if (res.metrics) {
          const sv = res.metrics.schedule_variance;
          const cv = res.metrics.cost_variance;

          // Cost insights
          if (cv < 0) {
            insightsHtml += `<p style="color:#ff3333;">ğŸ”´ <strong>Over Budget:</strong> You are $${Math.abs(cv).toLocaleString()} over budget.</p>`;
          } else {
            insightsHtml += `<p style="color:#00ffcc;">ğŸŸ¢ <strong>Under Budget:</strong> You are $${cv.toLocaleString()} under budget.</p>`;
          }

          // Schedule insights
          if (sv < 0) {
            insightsHtml += `<p style="color:#ff3333;">ğŸ”´ <strong>Behind Schedule:</strong> You are $${Math.abs(sv).toLocaleString()} behind schedule.</p>`;
          } else {
            insightsHtml += `<p style="color:#00ffcc;">ğŸŸ¢ <strong>Ahead of Schedule:</strong> You are $${sv.toLocaleString()} ahead of schedule.</p>`;
          }

          // Always show SPI & CPI
          insightsHtml += `<p><strong>Schedule Performance Index (SPI):</strong> ${res.metrics.schedule_performance_index}</p>`;
          insightsHtml += `<p><strong>Cost Performance Index (CPI):</strong> ${res.metrics.cost_performance_index}</p>`;
        }
        insightsDiv.innerHTML = insightsHtml;
        showElement(document.getElementById('insights'));
      })
      .catch(err => {
        sCurveDiv.innerHTML  = `<div style="color:red;text-align:center;">Error: ${err.message}</div>`;
        metricsDiv.innerHTML = '';
      });
    });
    // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€


    // â”€â”€â”€ FULLSCREEN GANTT MODAL (UNCHANGED) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    const ganttModal   = document.getElementById('gantt-modal');
    const closeModalEl = document.querySelector('.close-modal');

    function plotGanttFullscreen() {
      const fullscreenDiv = document.getElementById('fullscreen-gantt-chart');
      const ganttDiv      = document.getElementById('gantt-chart');
      const plotDataStr   = ganttDiv.dataset.plotData;
      const plotLayoutStr = ganttDiv.dataset.plotLayout;
      const projectName   = ganttDiv.dataset.projectName || 'Project';

      if (!plotDataStr || !plotLayoutStr) {
        fullscreenDiv.innerHTML = '<div style="color:orange;text-align:center;">Generate the chart first.</div>';
        return;
      }
      try {
        const data   = JSON.parse(plotDataStr);
        const layout = JSON.parse(plotLayoutStr);

        // Adjust layout for fullscreen:
        layout.height = Math.max(400, window.taskList.length * 40);
        layout.margin = { l: 150, r: 20, t: 100, b: 80 };
        layout.title = {
          text: projectName + ' Gantt Chart',
          font: { size: 24 },
          x: 0.5, xanchor: 'center'
        };

        plotGanttChartWithObserver('fullscreen-gantt-chart', data, layout);
      } catch (e) {
        fullscreenDiv.innerHTML = `<div style="color:red;text-align:center;">Error plotting fullscreen: ${e.message}</div>`;
      }
    }

    // Click on inline Gantt â†’ open modal & plot
    document.getElementById('gantt-chart').addEventListener('click', () => {
      ganttModal.classList.add('active');
      plotGanttFullscreen();
    });

    // Close modal
    closeModalEl.onclick = () => {
      ganttModal.classList.remove('active');
      document.getElementById('fullscreen-gantt-chart').innerHTML = '';
    };
    window.onclick = e => {
      if (e.target === ganttModal) {
        ganttModal.classList.remove('active');
        document.getElementById('fullscreen-gantt-chart').innerHTML = '';
      }
    };
    // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€


    // â”€â”€â”€ PLOTTING HELPER (ResizeObserver) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    function plotGanttChartWithObserver(containerId, plotData, plotLayout) {
      const container = document.getElementById(containerId);
      container.innerHTML = '';
      const observer = new ResizeObserver(entries => {
        for (let entry of entries) {
          const { width, height } = entry.contentRect;
          if (width > 0 && height > 0) {
            observer.disconnect();
            // Center the title
            if (plotLayout.title) {
              plotLayout.title.x = 0.5;
              plotLayout.title.xanchor = 'center';
            }

            // Adjust margins/font-sizes for mobile vs desktop:
            const isMobile = window.innerWidth < 768;
            const finalLayout = JSON.parse(JSON.stringify(plotLayout));
            if (isMobile) {
              finalLayout.margin = { l:80, r:10, t:60, b:60 };
              if (finalLayout.title && finalLayout.title.font) finalLayout.title.font.size = 14;
              if (finalLayout.xaxis && finalLayout.xaxis.title && finalLayout.xaxis.title.font) finalLayout.xaxis.title.font.size = 12;
              if (finalLayout.yaxis && finalLayout.yaxis.title && finalLayout.yaxis.title.font) finalLayout.yaxis.title.font.size = 12;
              if (finalLayout.yaxis && finalLayout.yaxis.tickfont) finalLayout.yaxis.tickfont.size = 10;
              if (finalLayout.annotations) {
                finalLayout.annotations.forEach(a => {
                  if (a.font) a.font.size = (a.font.size || 12)*0.8;
                  if (a.y) a.y -= 0.01;
                });
              }
            } else {
              finalLayout.margin = { l:150, r:20, t:80, b:80 };
              if (finalLayout.title && finalLayout.title.font) finalLayout.title.font.size = 24;
              if (finalLayout.xaxis && finalLayout.xaxis.title && finalLayout.xaxis.title.font) finalLayout.xaxis.title.font.size = 16;
              if (finalLayout.yaxis && finalLayout.yaxis.title && finalLayout.yaxis.title.font) finalLayout.yaxis.title.font.size = 16;
              if (finalLayout.yaxis && finalLayout.yaxis.tickfont) finalLayout.yaxis.tickfont.size = 12;
              if (finalLayout.annotations) {
                finalLayout.annotations.forEach(a => {
                  if (a.text === '[ Group 14 ]') { a.font.size = 16; a.y = 1.04; }
                  if (a.text === 'CIVL 303 Preliminary Design Gantt Chart') { a.font.size = 18; a.y = 1.07; }
                });
              }
            }

            setTimeout(() => {
              Plotly.newPlot(containerId, plotData, finalLayout, {
                responsive: true,
                displayModeBar: true,
                modeBarButtonsToRemove: ['toImage','lasso2d','select2d'],
                displaylogo: false
              }).catch(err => {
                container.innerHTML = `<div style="color:red;text-align:center;">Plot error: ${err.message}</div>`;
              });
            }, 10);
          }
        }
      });
      observer.observe(container);
    }
    // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  </script>
{% endblock %}
