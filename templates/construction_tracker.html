{% extends "base.html" %}
{% block title %}Construction Tracker - VibeOps{% endblock %}
{% block content %}
    <section class="contact" data-aos="fade-in" data-aos-duration="1000">
        <h2 data-aos="fade-up" data-aos-delay="100" class="glitch" data-text="Construction Tracker">Construction Tracker</h2>
        <p data-aos="fade-up" data-aos-delay="200" class="text-center text-gray-600">Upload project data to track progress and unravel performance mysteries.</p>
        
        <div class="max-w-md mx-auto bg-white p-8 rounded-lg shadow-md">
            <form id="trackerForm" class="space-y-6" enctype="multipart/form-data">
                <div>
                    <label for="project_name" class="block text-sm font-medium text-gray-700">Project Name</label>
                    <input type="text" name="project_name" id="project_name" required class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 sm:text-sm p-2">
                </div>
                
                <div>
                    <label for="data_file" class="block text-sm font-medium text-gray-700">Upload Data File (CSV or Excel)</label>
                    <input type="file" name="data_file" id="data_file" accept=".csv,.xls,.xlsx" required class="mt-1 block w-full text-sm text-gray-500 file:mr-4 file:py-2 file:px-4 file:rounded-md file:border-0 file:text-sm file:font-semibold file:bg-indigo-50 file:text-indigo-700 hover:file:bg-indigo-100">
                </div>
                
                <div>
                    <button type="submit" class="btn primary w-full flex justify-center">
                        Analyze the Abyss
                    </button>
                </div>
            </form>
            
            <div id="results" class="mt-8 hidden">
                <h3 class="text-xl font-semibold mb-4">Analysis Results</h3>
                <div id="analysis" class="mb-4 p-4 bg-gray-50 rounded-md"></div>
            </div>
        </div>
    </section>

    <script>
        document.getElementById('trackerForm').addEventListener('submit', function(event) {
            event.preventDefault();
            
            const form = event.target;
            const formData = new FormData(form);
            
            console.log('Form submitted');
            
            const resultsDiv = document.getElementById('results');
            const analysisDiv = document.getElementById('analysis');

            resultsDiv.classList.remove('hidden');
            analysisDiv.innerHTML = 'Processing data...';

            fetch('/construction-tracker', {
                method: 'POST',
                body: formData
            })
            .then(response => {
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                return response.json();
            })
            .then(result => {
                console.log('Backend response:', result);
                if (result.analysis_results) {
                    analysisDiv.innerHTML = '<h4 class="font-semibold">Analysis Summary:</h4>' +
                        `Project: ${result.project_name}<br>` +
                        `Cost Variance: ${result.analysis_results.cost_variance?.toLocaleString() || 'N/A'}<br>` +
                        `Schedule Variance: ${result.analysis_results.schedule_variance?.toLocaleString() || 'N/A'}<br>` +
                        `Critical Path Updates: ${result.analysis_results.critical_path_updates || 'N/A'}`;
                } else {
                    analysisDiv.innerHTML = '<h4 class="font-semibold">Analysis:</h4> Processing failed.';
                }
            })
            .catch(error => {
                console.error('Error during fetch:', error);
                analysisDiv.innerHTML = '<h4 class="font-semibold">Error:</h4> Failed to process data.';
            });
        });
    </script>
{% endblock %}