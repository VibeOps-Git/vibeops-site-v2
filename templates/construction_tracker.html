{% extends "base.html" %}
{% block title %}Construction Tracker - VibeOps{% endblock %}

{% block extra_head %}
    <script src="https://cdn.plot.ly/plotly-2.18.1.min.js"></script> {# Include Plotly library #}
    {# Add MathJax if you plan to display formulas in metrics #}
    {# <script id="MathJax-script" async src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script> #}
{% endblock %}

{% block content %}
    <section class="construction-tracker-page"> {# Use a unique class for this page #}
        <h2 data-aos="fade-up" data-aos-delay="100" class="glitch" data-text="Construction Tracker">Construction Tracker</h2>
        <p data-aos="fade-up" data-aos-delay="200" class="text-center">Define project tasks, track progress, and visualize performance with Gantt charts and S-curves.</p>
        
        <div class="input-section" data-aos="fade-up" data-aos-delay="300"> {# Use input-section class #}
                <div>
                <label for="project_name">Project Name</label>
                <input type="text" name="project_name" id="project_name" class="project_name" required placeholder="e.g., Office Building Renovation"> {# Added placeholder #}
                </div>
                
            <div id="task-list" class="space-y-6 mt-4">
                <h3 class="text-xl font-semibold" style="color: #00a886; margin-top:10px;">Define Project Tasks</h3> {# Themed heading #}
                <div id="tasks-container">
                    {# Task input rows will be added here by JavaScript #}
                </div>
                <button type="button" id="add-task" class="btn secondary w-full flex justify-center">Add Task</button> {# Themed button #}
            </div>

            <div class="mt-4">
                <button type="button" id="generate-gantt" class="btn primary w-full flex justify-center">Generate Plan (Gantt Chart)</button> {# Themed button #}
                 <div id="task-form-error-message" class="text-center" style="color: red; margin-top: 1rem;"></div> {# Area for displaying task input errors #}
            </div>
        </div>

        <!-- Gantt Chart Display -->
        <div id="gantt-results" class="output-section mt-8 hidden"> {# Use output-section and hidden #}
            <h2>Project Gantt Chart</h2> {# Use h2 #}
            <div id="gantt-chart" class="box"> {# Use box #}
                 {# Gantt chart will be plotted here by Plotly #}
            </div>
                </div>
                
        <!-- Progress Rating Interface -->
        <div id="progress-section" class="input-section mt-8 hidden"> {# Use input-section and hidden #}
            <h3 class="text-xl font-semibold mb-4" style="color: #00a886;">Report Progress & Costs</h3> {# Themed heading #}
             <div id="progress-form-error-message" class="text-center" style="color: red; margin-bottom: 1rem;"></div> {# Area for displaying progress input errors #}
            <div id="progress-list" class="space-y-4">
                {# Progress input rows will be populated here by JavaScript #}
            </div>
            <button type="button" id="submit-progress" class="btn primary w-full flex justify-center mt-4">Analyze Progress (S-Curves)</button> {# Themed button #}
                </div>

        <!-- S-Curve and Analysis Results -->
        <div id="analysis-results" class="output-section mt-8 hidden"> {# Use output-section and hidden #}
            <h2>Performance Analysis</h2> {# Use h2 #}
            <div id="s-curve-chart" class="box mb-4"> {# Use box #}
                {# S-curve chart will be plotted here by Plotly #}
            </div>
            <div id="metrics" class="box"> {# Use box #}
                {# Performance metrics will be displayed here #}
            </div>
        </div>
    </section>

{% endblock %}

{% block extra_scripts %} {# Use extra_scripts block #}
    <script>
        // Task Input Management
        let taskCount = 0;
        const tasksContainer = document.getElementById('tasks-container');
        const addTaskButton = document.getElementById('add-task');
        let taskList = []; // Store tasks globally after Gantt generation

        // Function to add a task input row
        function addTaskRow(task = {}) {
            taskCount++;
            const taskRow = document.createElement('div');
            taskRow.className = 'task-row';
            taskRow.id = `task-${taskCount}`;
            taskRow.innerHTML = `
                <textarea placeholder="Task Name" class="task-name" required>${task.activityName || ''}</textarea>
                <input type="date" placeholder="Start Date" class="task-start" value="${task.start || ''}" required>
                <input type="number" placeholder="Duration (days)" class="task-duration" value="${task.duration || ''}" min="1" required>
                <textarea placeholder="Predecessors (comma-separated task names)" class="task-predecessors">${(task.immediatePredecessor || []).join(', ')}</textarea>
                <button type="button" class="remove-task btn secondary">Remove</button>
            `;
            tasksContainer.appendChild(taskRow);

            // Add event listener to the remove button
            taskRow.querySelector('.remove-task').addEventListener('click', () => {
                tasksContainer.removeChild(taskRow);
            });
        }

        // Add initial task row on page load
        document.addEventListener('DOMContentLoaded', () => {
            addTaskRow(); // Add one row to start with
            checkAndShowModal();
        });

        // Event listener for "Add Task" button
        addTaskButton.addEventListener('click', () => {
            addTaskRow();
        });

        // Generate Gantt Chart
        document.getElementById('generate-gantt').addEventListener('click', () => {
            const projectName = document.getElementById('project_name').value.trim();
            const taskFormErrorMessageDiv = document.getElementById('task-form-error-message');
            taskFormErrorMessageDiv.textContent = '';

            if (!projectName) {
                taskFormErrorMessageDiv.textContent = 'Please enter a project name.';
                document.getElementById('project_name').style.borderColor = 'red';
                return;
            } else {
                document.getElementById('project_name').style.borderColor = '';
            }

            const taskRows = tasksContainer.querySelectorAll('.task-row');
            taskList = [];

            let formIsValid = true;
            taskRows.forEach(row => {
                const nameInput = row.querySelector('.task-name');
                const startInput = row.querySelector('.task-start');
                const durationInput = row.querySelector('.task-duration');
                const predecessorsInput = row.querySelector('.task-predecessors');

                const name = nameInput.value.trim();
                const start = startInput.value;
                const duration = parseInt(durationInput.value);
                const predecessors = predecessorsInput.value.split(',').map(p => p.trim()).filter(p => p !== '');

                if (!name || !start || isNaN(duration) || duration <= 0) {
                    formIsValid = false;
                    nameInput.style.borderColor = name ? '' : 'red';
                    startInput.style.borderColor = start ? '' : 'red';
                    durationInput.style.borderColor = (!isNaN(duration) && duration > 0) ? '' : 'red';
                } else {
                    nameInput.style.borderColor = '';
                    startInput.style.borderColor = '';
                    durationInput.style.borderColor = '';
                    taskList.push({
                        activityName: name,
                        start: start,
                        duration: duration,
                        immediatePredecessor: predecessors
                    });
                }
            });

            if (!formIsValid) {
                taskFormErrorMessageDiv.textContent = 'Please fill in all required task details correctly.';
                return;
            }

            if (taskList.length === 0) {
                taskFormErrorMessageDiv.textContent = 'Please add at least one task.';
                return;
            }

            const taskNames = taskList.map(task => task.activityName);
            for (const task of taskList) {
                for (const pred of task.immediatePredecessor) {
                    if (!taskNames.includes(pred)) {
                        taskFormErrorMessageDiv.textContent = `Predecessor "${pred}" not found in task list for task "${task.activityName}".`;
                        return;
                    }
                }
            }

            const ganttChartDiv = document.getElementById('gantt-chart');
            const ganttResultsDiv = document.getElementById('gantt-results');
            ganttResultsDiv.classList.remove('hidden');
            ganttChartDiv.innerHTML = '<div style="color: #00ffcc; text-align: center;">Generating Gantt chart...</div>';

            fetch('/construction-tracker', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({project_name: projectName, tasks: taskList})
            })
            .then(response => response.ok ? response.json() : response.json().then(data => { throw new Error(data.error || `HTTP error! status: ${response.status}`); }))
            .then(result => {
                console.log('Gantt Backend response:', result);
                if (result.gantt_data) {
                    ganttChartDiv.innerHTML = '';

                    const plotData = result.gantt_data.data;
                    const plotLayout = result.gantt_data.layout;

                    // --- Improve Gantt Chart Styling ---
                    plotLayout.title = {
                        text: projectName + ' Gantt Chart',
                        font: { 
                            color: '#00ffcc', 
                            family: "'Orbitron', sans-serif",
                            size: 24 
                        },
                        xref: 'paper',
                        x: 0.5,
                        xanchor: 'center'
                    };
                    plotLayout.xaxis = {
                        title: {
                            text: 'Timeline',
                            font: { 
                                color: '#f2f2f2', 
                                family: "'Inter', sans-serif",
                                size: 16 
                            }
                        },
                        type: 'date',
                        tickformat: '%b %d, %Y',
                        tickangle: 45,
                        showgrid: true,
                        gridcolor: '#444',
                        zeroline: false,
                        linecolor: '#555',
                        linewidth: 1,
                        tickfont: { 
                            color: '#ccc', 
                            family: "'Inter', sans-serif",
                            size: 12 
                        }
                    };
                    plotLayout.yaxis = {
                        title: {
                            text: 'Tasks',
                            font: { 
                                color: '#f2f2f2', 
                                family: "'Inter', sans-serif",
                                size: 16 
                            }
                        },
                        autorange: 'reversed',
                        showgrid: true,
                        gridcolor: '#444',
                        zeroline: false,
                        linecolor: '#555',
                        linewidth: 1,
                        tickfont: { 
                            color: '#ccc', 
                            family: "'Inter', sans-serif",
                            size: 12 
                        },
                        ticklen: 5,
                        tickwidth: 1,
                        tickcolor: '#555'
                    };
                    plotLayout.plot_bgcolor = '#1e1e1e';
                    plotLayout.paper_bgcolor = '#1e1e1e';
                    plotLayout.font = { 
                        color: '#f2f2f2',
                        family: "'Inter', sans-serif",
                        size: 12 
                    };
                    plotLayout.margin = { l: 150, r: 20, t: 80, b: 80 };
                    plotLayout.bargap = 0.3; // Add spacing between bars
                    plotLayout.height = Math.max(400, taskList.length * 40); // Dynamic height based on number of tasks

                    // Style the bars
                    plotData.forEach(trace => {
                        trace.opacity = 0.8;
                        trace.hoverinfo = 'text';
                        trace.textposition = 'inside';
                        trace.textfont = { 
                            color: '#0e0e0e', 
                            family: "'Inter', sans-serif",
                            size: 12 
                        };
                        trace.marker = {
                            line: {
                                color: '#555',
                                width: 1
                            }
                        };
                    });

                    // Get critical activities from response and style
                    const criticalActivities = result.critical_path_activities || [];
                    plotData.forEach(trace => {
                        // Initialize marker colors array
                        trace.marker = trace.marker || {};
                        trace.marker.color = Array(trace.y.length).fill('#00ffcc'); // Default color

                        // Highlight critical path tasks in red
                        if (criticalActivities.length > 0 && trace.y) {
                            trace.y.forEach((activityName, index) => {
                                if (criticalActivities.includes(activityName)) {
                                    trace.marker.color[index] = '#ff3333'; // Red for critical path
                                }
                            });
                        }
                    });

                     // Deduplicate y-axis labels (if necessary) - This part should ideally be handled in backend data prep.
                     // Keeping it here as a client-side workaround if backend data isn't perfectly ordered/unique for plotting.
                     const yLabels = plotData[0].y;
                     const uniqueYLabels = [];
                     const seenLabels = new Set();
                     yLabels.forEach((label, index) => {
                         let newLabel = label;
                         let suffix = 1;
                         while (seenLabels.has(newLabel)) {
                             newLabel = `${label} (${suffix})`;
                             suffix++;
                         }
                         seenLabels.add(newLabel);
                         uniqueYLabels[index] = newLabel;
                     });
                     plotData[0].y = uniqueYLabels;

                     // Adjust bar width to prevent overlap
                     plotData.forEach(trace => {
                         trace.width = 0.6; // Reduce bar width to prevent overlap
                     });

                    Plotly.newPlot('gantt-chart', plotData, plotLayout, { 
                        responsive: true,
                        displayModeBar: true,
                        modeBarButtonsToRemove: ['toImage', 'lasso2d', 'select2d'],
                        displaylogo: false
                    });
                    taskList = result.processed_tasks;
                    populateProgressSection();
                } else {
                    ganttChartDiv.innerHTML = '<div style="color: red; text-align: center;">Failed to generate Gantt chart. No data received.</div>';
                }
            })
            .catch(error => {
                console.error('Error generating Gantt:', error);
                ganttChartDiv.innerHTML = '<div style="color: red; text-align: center;">Error generating Gantt chart: ' + error.message + '</div>';
                document.getElementById('progress-section').classList.add('hidden');
                document.getElementById('analysis-results').classList.add('hidden');
            });
        });

        // Function to populate the progress rating section
        function populateProgressSection() {
            const progressSectionDiv = document.getElementById('progress-section');
            const progressListDiv = document.getElementById('progress-list');
            progressListDiv.innerHTML = '';

            if (taskList.length > 0) {
                // Add headers for the progress table/list
                const headerRow = document.createElement('div');
                headerRow.className = 'progress-row header';
                headerRow.innerHTML = `
                    <label>Task Name</label>
                    <label>Budgeted Cost ($)</label>
                    <label>Actual Cost ($)</label>
                    <label>% Complete</label>
                    <label>Actual Start</label>
                    <label>Actual Finish</label>
                `;
                progressListDiv.appendChild(headerRow);

                taskList.forEach((task, index) => {
                    const progressRow = document.createElement('div');
                    progressRow.className = 'progress-row';
                    progressRow.innerHTML = `
                        <label>${task.activityName}</label>
                        <input type="number" placeholder="Budgeted Cost ($)" min="0" class="budgeted-cost" data-task-index="${index}" value="0">
                        <input type="number" placeholder="Actual Cost ($)" min="0" class="actual-cost" data-task-index="${index}" value="0">
                        <input type="number" placeholder="% Complete" min="0" max="100" class="progress-percent" data-task-index="${index}" value="0">
                        <input type="date" placeholder="Actual Start" class="actual-start" data-task-index="${index}">
                        <input type="date" placeholder="Actual Finish" class="actual-finish" data-task-index="${index}">
                    `;
                    progressListDiv.appendChild(progressRow);
                });
                progressSectionDiv.classList.remove('hidden');
            } else {
                progressSectionDiv.classList.add('hidden');
            }
        }

        // Submit Progress and Generate S-Curves and Metrics
        document.getElementById('submit-progress').addEventListener('click', () => {
            const progressFormErrorMessageDiv = document.getElementById('progress-form-error-message');
            progressFormErrorMessageDiv.textContent = '';

            const progressData = [];
            const progressRows = document.querySelectorAll('#progress-list .progress-row:not(.header)'); // Exclude header row
            let progressFormIsValid = true;

            progressRows.forEach(row => {
                const percentInput = row.querySelector('.progress-percent');
                const costInput = row.querySelector('.actual-cost');
                const budgetedCostInput = row.querySelector('.budgeted-cost');
                const actualStartInput = row.querySelector('.actual-start');
                const actualFinishInput = row.querySelector('.actual-finish');

                const index = parseInt(percentInput.dataset.taskIndex);
                const percentComplete = parseFloat(percentInput.value);
                const actualCost = parseFloat(costInput.value);
                const budgetedCost = parseFloat(budgetedCostInput.value);
                const actualStart = actualStartInput.value;
                const actualFinish = actualFinishInput.value;

                // Basic validation for new fields
                if (isNaN(budgetedCost) || budgetedCost < 0) {
                     progressFormIsValid = false;
                     budgetedCostInput.style.borderColor = 'red';
                } else {
                    budgetedCostInput.style.borderColor = '';
                }

                // Add validation for date formats if necessary, though input type="date" helps
                // You might want to add checks if dates are logically valid (e.g., start before finish)

                if (isNaN(percentComplete) || percentComplete < 0 || percentComplete > 100 || isNaN(actualCost) || actualCost < 0) {
                    progressFormIsValid = false;
                    percentInput.style.borderColor = (!isNaN(percentComplete) && percentComplete >= 0 && percentComplete <= 100) ? '' : 'red';
                    costInput.style.borderColor = (!isNaN(actualCost) && actualCost >= 0) ? '' : 'red';
                } else {
                    percentInput.style.borderColor = '';
                    costInput.style.borderColor = '';
                }

                if (progressFormIsValid) { // Only push if the current row is valid so far
                    progressData.push({
                        taskIndex: index,
                        percentComplete: percentComplete,
                        actualCost: actualCost,
                        budgetedCost: budgetedCost,
                        actualStart: actualStart,
                        actualFinish: actualFinish
                    });
                }
            });

            if (!progressFormIsValid) {
                progressFormErrorMessageDiv.textContent = 'Please fill in all required progress details correctly.';
                return;
            }

            const sCurveChartDiv = document.getElementById('s-curve-chart');
            const metricsDiv = document.getElementById('metrics');
            const analysisResultsDiv = document.getElementById('analysis-results');
            analysisResultsDiv.classList.remove('hidden');
            sCurveChartDiv.innerHTML = 'Analyzing progress...';
            metricsDiv.innerHTML = 'Calculating metrics...';

            fetch('/construction-tracker-progress', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({tasks: taskList, progress: progressData, report_date: new Date().toISOString().split('T')[0]})
            })
            .then(response => response.ok ? response.json() : response.json().then(data => { throw new Error(data.error || `HTTP error! status: ${response.status}`); }))
            .then(result => {
                console.log('Analysis Backend response:', result);
                sCurveChartDiv.innerHTML = '';
                metricsDiv.innerHTML = '';
                if (result.s_curve_data) {
                    Plotly.newPlot('s-curve-chart', result.s_curve_data.data, result.s_curve_data.layout, { responsive: true });
                } else {
                    sCurveChartDiv.innerHTML = '<div style="color: red;">Failed to generate S-curves.</div>';
                }
                if (result.metrics) {
                    metricsDiv.innerHTML = `
                        <h4 class="font-semibold" style="color: #00ffcc;">Performance Metrics:</h4>
                        <p><strong>Schedule Variance (SV):</strong> ${result.metrics.schedule_variance ? '$' + result.metrics.schedule_variance.toLocaleString() : 'N/A'}</p>
                        <p><strong>Cost Variance (CV):</strong> ${result.metrics.cost_variance ? '$' + result.metrics.cost_variance.toLocaleString() : 'N/A'}</p>
                        <p><strong>Critical Path:</strong> ${result.metrics.critical_path ? result.metrics.critical_path : 'N/A'}</p>
                        ${result.metrics.critical_path_updates ? `<p style="color: yellow;"><strong>Critical Path Updates:</strong> ${result.metrics.critical_path_updates}</p>` : ''}
                        ${result.metrics.analysis_notes ? `<p style="color: yellow;"><strong>Notes:</strong> ${result.metrics.analysis_notes}</p>` : ''}
                    `;
                } else {
                    metricsDiv.innerHTML = '<div style="color: red;">Failed to calculate metrics.</div>';
                }
            })
            .catch(error => {
                console.error('Error generating analysis:', error);
                sCurveChartDiv.innerHTML = '<div style="color: red;">Error generating analysis: ' + error.message + '</div>';
                metricsDiv.innerHTML = '';
            });
        });

        // Example data for Bridge Footings project
        const exampleTasks = [
            { activityName: 'start', start: '2025-05-12', duration: 1, immediatePredecessor: [] },
        
            // Site Preparation
            { activityName: 'Mobilize Equipment', start: '2025-05-13', duration: 3, immediatePredecessor: ['start'] },
            { activityName: 'Install Safety Barriers & Signage', start: '2025-05-16', duration: 2, immediatePredecessor: ['Mobilize Equipment'] },
            { activityName: 'Preliminary Site Survey', start: '2025-05-18', duration: 2, immediatePredecessor: ['Install Safety Barriers & Signage'] },
        
            // Demolition Phase
            { activityName: 'Remove Rebar from Footings', start: '2025-05-20', duration: 4, immediatePredecessor: ['Preliminary Site Survey'] },
            { activityName: 'Demolish Damaged Concrete Footings', start: '2025-05-24', duration: 5, immediatePredecessor: ['Remove Rebar from Footings'] },
            { activityName: 'Excavate Surrounding Soil', start: '2025-05-29', duration: 3, immediatePredecessor: ['Demolish Damaged Concrete Footings'] },
        
            // Formwork & Substructure
            { activityName: 'Build Footing Formwork', start: '2025-06-01', duration: 4, immediatePredecessor: ['Excavate Surrounding Soil'] },
            { activityName: 'Install Rebar Framework', start: '2025-06-05', duration: 3, immediatePredecessor: ['Build Footing Formwork'] },
            { activityName: 'Pour Concrete for New Footings', start: '2025-06-08', duration: 3, immediatePredecessor: ['Install Rebar Framework'] },
        
            // Curing & Backfill
            { activityName: 'Initial Concrete Curing Period', start: '2025-06-11', duration: 7, immediatePredecessor: ['Pour Concrete for New Footings'] },
            { activityName: 'Backfill Excavated Area', start: '2025-06-18', duration: 2, immediatePredecessor: ['Initial Concrete Curing Period'] },
        
            // Finishing & QA
            { activityName: 'Install Siding and Surface Finish', start: '2025-06-20', duration: 3, immediatePredecessor: ['Backfill Excavated Area'] },
            { activityName: 'Final Survey & Inspection', start: '2025-06-23', duration: 2, immediatePredecessor: ['Install Siding and Surface Finish'] },
            { activityName: 'Demobilize Site & Cleanup', start: '2025-06-25', duration: 2, immediatePredecessor: ['Final Survey & Inspection'] },
        
            // End
            { activityName: 'project_complete', start: '2025-06-27', duration: 1, immediatePredecessor: ['Demobilize Site & Cleanup'] }
        ];
      

        // Helper to append a styled bot message
        function appendBotMessage(html) {
            const msgs = document.getElementById('chatbot-messages');
            if (!msgs) return;

            // Remove any existing modals first
            const existingModals = msgs.querySelectorAll('.chat-modal');
            existingModals.forEach(modal => modal.remove());

            const div = document.createElement('div');
            div.classList.add('message', 'bot-message', 'chat-modal');
            div.innerHTML = html;
            msgs.appendChild(div);
            msgs.scrollTop = msgs.scrollHeight;
        }

        // Helper function to add a typing indicator
        function addTypingIndicator() {
            const msgs = document.getElementById('chatbot-messages');
            if (!msgs) return;
            removeTypingIndicator();

            const typingDiv = document.createElement('div');
            typingDiv.classList.add('message', 'bot-message', 'typing-indicator');
            typingDiv.innerHTML = '<span>.</span><span>.</span><span>.</span>';
            msgs.appendChild(typingDiv);
            msgs.scrollTop = msgs.scrollHeight;
        }

        // Helper function to remove the typing indicator
        function removeTypingIndicator() {
            const typingDiv = document.querySelector('.typing-indicator');
            if (typingDiv) typingDiv.remove();
        }

        // Function to show the example modal
        function showExampleModal() {
            const chatWin = document.querySelector('.chatbot-window');
            if (!chatWin) return;

            // Show typing indicator and then modal
            addTypingIndicator();
            setTimeout(() => {
                removeTypingIndicator();
                appendBotMessage(`
                    <p><strong>President:</strong> Want me to drop in an example schedule to get you started?</p>
                    <button id="modal-yes" class="btn primary">Yes, please!</button>
                    <button id="modal-no" class="btn secondary">No, thanks</button>
                `);
            }, 1500);
        }

        // Function to check and show modal if needed
        function checkAndShowModal() {
            const chatWin = document.querySelector('.chatbot-window');
            if (chatWin && chatWin.classList.contains('active')) {
                showExampleModal();
            }
        }

        // Initialize on page load
        document.addEventListener('DOMContentLoaded', () => {
            addTaskRow(); // Add initial task row

            // Set up observer for chat window state changes
            const chatWin = document.querySelector('.chatbot-window');
            if (chatWin) {
                const observer = new MutationObserver((mutations) => {
                    mutations.forEach(mutation => {
                        if (mutation.attributeName === 'class' && chatWin.classList.contains('active')) {
                            showExampleModal();
                        }
                    });
                });
                observer.observe(chatWin, { attributes: true });

                // Check if chat is already open
                if (chatWin.classList.contains('active')) {
                    showExampleModal();
                }
            }
        });

        // Handle Yes/No clicks on the modal prompt
        document.body.addEventListener('click', e => {
            if (e.target.id === 'modal-no') {
                const modal = e.target.closest('.chat-modal');
                if (modal) modal.remove();
            }

            if (e.target.id === 'modal-yes') {
                const modal = e.target.closest('.chat-modal');
                if (modal) modal.remove();

                // Populate example data
                document.getElementById('tasks-container').innerHTML = '';
                document.getElementById('project_name').value = 'Bridge Footings';
                exampleTasks.forEach(task => addTaskRow(task));

                // Close the chat window
                const chatWin = document.querySelector('.chatbot-window');
                const chatToggle = document.querySelector('.chatbot-toggle');
                if (chatWin) {
                    chatWin.classList.remove('active');
                    if (chatToggle) {
                        chatToggle.classList.remove('chatbot-hidden');
                        chatToggle.setAttribute('aria-expanded', 'false');
                    }
                }
            }
        });

        // The actual chat sending/receiving, history loading/saving, and clear chat
        // logic is expected to be defined in the main <script> block of base.html.
        // We do NOT define or override appendMessage, sendMessage, saveChatHistory, or clearChat here.
        // This script block only adds page-specific behavior (scroll-to-open, modal prompt, typing indicator helpers).

    </script>

    <style>
        /* Chat modal styling */
        #chatbot-messages .chat-modal {
            background: #1e1e1e;
            border: 1px solid #444;
            border-radius: 8px;
            padding: 1rem;
            margin: .5rem 0;
            text-align: center;
            display: flex;
            flex-direction: column;
            align-items: center;
        }

        #chatbot-messages .chat-modal p {
            margin-bottom: .5rem;
            color: #f2f2f2;
        }

        #chatbot-messages .chat-modal .btn {
            margin: .5rem .25rem;
            font-size: 1rem;
            padding: .5rem 1rem;
        }

        /* Typing indicator styles */
        .typing-indicator span {
            animation: blink 1s infinite;
        }

        .typing-indicator span:nth-child(2) {
            animation-delay: 0.2s;
        }

        .typing-indicator span:nth-child(3) {
            animation-delay: 0.4s;
        }

        @keyframes blink {
            0%, 100% { opacity: 0; }
            50% { opacity: 1; }
        }
    </style>
{% endblock %}